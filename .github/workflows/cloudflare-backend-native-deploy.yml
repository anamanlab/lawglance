name: Cloudflare Backend Native Deploy

on:
  workflow_dispatch:

concurrency:
  group: cloudflare-backend-native-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-backend-native:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"

      - name: Validate Cloudflare credentials are configured
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -z "${CLOUDFLARE_API_TOKEN}" ]; then
            echo "CLOUDFLARE_API_TOKEN secret is required."
            exit 1
          fi
          if [ -z "${CLOUDFLARE_ACCOUNT_ID}" ]; then
            echo "CLOUDFLARE_ACCOUNT_ID secret is required."
            exit 1
          fi

      - name: Sync backend runtime source for native worker
        run: bash scripts/sync_backend_cloudflare_native_source.sh

      - name: Setup Python worker toolchain
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install uv
          cd backend-cloudflare
          uv sync --dev

      - name: Deploy backend native Python worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd backend-cloudflare
          uv run pywrangler deploy
