name: Cloudflare Frontend Deploy

on:
  push:
    branches:
      - main
    paths:
      - "frontend-web/**"
      - ".github/workflows/cloudflare-frontend-deploy.yml"
  workflow_dispatch:

concurrency:
  group: cloudflare-frontend-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-frontend-worker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend-web/package-lock.json

      - name: Validate Cloudflare credentials are configured
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -z "${CLOUDFLARE_API_TOKEN}" ]; then
            echo "CLOUDFLARE_API_TOKEN secret is required."
            exit 1
          fi
          if [ -z "${CLOUDFLARE_ACCOUNT_ID}" ]; then
            echo "CLOUDFLARE_ACCOUNT_ID secret is required."
            exit 1
          fi

      - name: Install frontend dependencies
        run: npm ci --prefix frontend-web

      - name: Frontend typecheck
        run: npm run typecheck --prefix frontend-web

      - name: Frontend contract tests
        run: npm run test --prefix frontend-web

      - name: Build OpenNext Cloudflare bundle
        run: npm run cf:build --prefix frontend-web

      - name: Deploy frontend to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx --yes wrangler@4.68.1 deploy --config frontend-web/wrangler.jsonc
