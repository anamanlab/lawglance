# Ralph Progress Log
Started: 2026-02-23

## Codebase Patterns
- Run `make quality` before each commit.
- Keep architecture docs in sync when changing API contracts or runtime behavior.
- Canada-only legal scope is mandatory; avoid India-domain terms outside legacy archival files.

---
## 2026-02-23 18:19:13 -0300 - US-001
- Implemented a reusable domain-leak scanner (`scripts/scan_domain_leaks.py`) that scans source/docs paths for disallowed India-domain legal terms, supports an explicit legacy-file allowlist, and reports file/line context with non-zero exit on violations.
- Files changed
- `scripts/scan_domain_leaks.py`
- `tests/test_domain_leak_scanner.py`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern: Implement validation scripts as importable modules with a small `main()` that returns an exit code so unit tests can cover both library behavior and CLI output.
  - Gotcha: `make` is not installed here, so `make quality` must be executed via the Makefile command sequence manually; full `pytest` currently fails earlier on a pre-existing unrelated `ChatService` constructor mismatch from dirty workspace changes.
  - Useful context: `scripts/scan_domain_leaks.py` defaults to scanning top-level app modules plus `src/immcad_api` and `docs`, with allowlisted legacy files for expected historical references.
---
## 2026-02-23 18:33:41 -0300 - US-002
- Wired the domain-leak scanner into both local and CI quality gates by adding a dedicated Makefile target and making it part of `quality`, plus a new `quality-gates.yml` step that runs the scanner before evaluation artifacts.
- Files changed
- `Makefile`
- `.github/workflows/quality-gates.yml`
- `tests/test_ralph_prd_json.py`
- `src/immcad_api/services/chat_service.py`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern: Add new guardrail scripts as first-class Makefile targets, then compose them into `quality` and mirror the same order in CI workflows.
  - Gotcha: `make` is not installed in this environment, so `make quality` must be executed via the Makefile command sequence manually and in order.
  - Useful context: Updating story `passes` flags requires `tests/test_ralph_prd_json.py` to validate boolean shape instead of enforcing all stories as incomplete.
---
## 2026-02-23 19:17:44 -0300 - US-003
- Implemented structured audit events in the chat flow for `policy_block` and `provider_error`, threading `trace_id` from the API route to `ChatService` and emitting non-PII metadata (`locale`, `mode`, `message_length`, plus provider/error code when applicable).
- Files changed
- `src/immcad_api/api/routes/chat.py`
- `src/immcad_api/services/chat_service.py`
- `tests/test_chat_service.py`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern: Emit audit logs through a dedicated logger (`immcad_api.audit`) with a single structured `audit_event` payload for stable tests and downstream parsing.
  - Gotcha: `scripts/ralph/prd.json` can differ by branch, so pick the story from the active branch-local PRD before coding.
  - Useful context: Pass `trace_id` from route handlers into service methods whenever service-layer audit events are required.
---
## 2026-02-23 19:29:38 -0300 - US-004
- Added a new ingestion checkpoint recovery runbook with explicit checkpoint file location, corruption recovery flow, full/cadence replay commands, and a post-recovery verification checklist.
- Files changed
- `docs/release/ingestion-checkpoint-recovery.md`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern: Keep operational runbooks command-driven with copy/paste-ready shell blocks and checklist verification commands for faster on-call execution.
  - Gotcha: Ralph PRD branch pointers can differ across branches; verify and follow the branch-local story backlog before implementation.
  - Useful context: Ingestion checkpoint state lives at `artifacts/ingestion/checkpoints.json` and can be safely rebuilt by replaying `scripts/run_ingestion_jobs.py` with `--state-path`.
---
## 2026-02-23 19:53:34 -0300 - US-005
- Implemented a release artifact validator (`scripts/validate_release_artifacts.py`) that enforces presence, readability, non-empty content, and JSON validity for required jurisdiction evaluation artifacts, then wired it into `release-gates.yml` before smoke/hygiene/upload steps.
- Files changed: `.github/workflows/release-gates.yml`, `scripts/validate_release_artifacts.py`, `tests/test_validate_release_artifacts.py`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern: keep release gate validators importable with a small CLI wrapper so unit tests can directly assert failure categories without shelling out.
  - Gotcha: running `ruff` on YAML paths produces parser noise; lint only Python paths and validate workflows via CI execution.
  - Useful context: release evidence now hard-fails if any of the four eval artifacts are missing, blank, or malformed JSON before upload.
---
## 2026-02-23 20:13:18 -0300 - US-001
- What was implemented
- Added the missing tribunal rules source IDs for ID/IAD/RPD/RAD and compliance source IDs for PIPEDA, CASL, and CanLII Terms to the canonical Canada source registry with valid HTTPS URLs and allowed source metadata fields.
- Files changed
- `data/sources/canada-immigration/registry.json`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern: Keep the legal source registry grouped by legal domain (statutes/regulations/policy/case-law) so future source additions remain reviewable and diff-friendly.
  - Gotcha: `make` is unavailable in this environment, so `make quality` must be executed via the exact Makefile command sequence.
  - Useful context: `source_type` is constrained to `statute|regulation|policy|case_law` and `update_cadence` to `daily|weekly|scheduled_incremental`; invalid values fail registry load/quality checks.
---
