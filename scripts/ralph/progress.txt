# Ralph Progress Log
Started: 2026-02-23

## Codebase Patterns
- Run `make quality` before each commit.
- Keep architecture docs in sync when changing API contracts or runtime behavior.
- Canada-only legal scope is mandatory; avoid India-domain terms outside legacy archival files.

---
## 2026-02-23 17:23:51 -03 - US-001
- Implemented a dedicated India-domain leak scanner script with Canada-scope defaults, explicit allowlist handling, and non-zero exit on violations with file/line output.
- Files changed: scripts/scan_domain_leaks.py, tests/test_domain_leak_scanner.py, scripts/ralph/prd.json, scripts/ralph/progress.txt.
- Learnings for future iterations:
  - Reusable pattern: Keep scanner logic testable via a `main(argv)` entrypoint plus pure scanning helpers.
  - Gotcha: `importlib`-loaded test modules that use `@dataclass` must be added to `sys.modules` before `exec_module`.
  - Useful context: Current repo has approved India-term references in migration-history docs and jurisdiction-evaluation modules, so explicit path allowlisting is required.
---
## 2026-02-23 17:26:24 -0300 - US-002
- Integrated the Canada domain-leak scanner into local quality gates and CI quality workflow enforcement.
- Files changed: Makefile, .github/workflows/quality-gates.yml, scripts/ralph/prd.json, scripts/ralph/progress.txt.
- Learnings for future iterations:
  - Reusable pattern: Add policy scanners as dedicated Make targets and invoke the same script path in CI for parity.
  - Gotcha: `make` may be unavailable in some environments, so run equivalent target commands directly to preserve gate coverage.
  - Useful context: Quality gates now include domain leakage checks before jurisdiction evaluation and suite artifacts are generated.
---
## 2026-02-23 17:29:30 -0300 - US-003
- Implemented structured audit logging in chat flows for policy blocks and provider failures, carrying trace_id, event_type, and non-PII metadata.
- Files changed: src/immcad_api/services/chat_service.py, src/immcad_api/api/routes/chat.py, tests/test_chat_service.py, scripts/ralph/prd.json, scripts/ralph/progress.txt.
- Learnings for future iterations:
  - Reusable pattern: Attach structured audit fields through `logging` `extra` payloads so tests can assert record attributes without coupling to formatter output.
  - Gotcha: `trace_id` is only guaranteed at route/middleware boundaries, so pass it explicitly into service methods that need audit visibility.
  - Useful context: Jurisdiction suite exercises policy refusal paths, so new audit logging will surface during quality runs and should remain non-PII.
---
## 2026-02-23 17:32:52 -0300 - US-004
- Implemented an ingestion checkpoint recovery runbook documenting checkpoint location, corruption recovery, replay commands, and post-recovery verification.
- Files changed: docs/release/ingestion-checkpoint-recovery.md, scripts/ralph/prd.json, scripts/ralph/progress.txt.
- Learnings for future iterations:
  - Reusable pattern: Recovery docs should include exact runner commands with `--state-path` so operators can override defaults safely.
  - Gotcha: Deleting or moving the checkpoint file intentionally triggers full refresh behavior because ingestion loads empty state when the file is absent.
  - Useful context: `scripts/run_ingestion_jobs.py` defaults checkpoint state to `artifacts/ingestion/checkpoints.json`, so runbook steps must align with that path.
---
## 2026-02-23 17:35:35 -0300 - US-005
- Implemented release artifact verification by adding a dedicated validator for required jurisdiction evaluation artifacts and wiring it into `release-gates` before job completion.
- Files changed: scripts/verify_release_eval_artifacts.py, tests/test_verify_release_eval_artifacts.py, .github/workflows/release-gates.yml, scripts/ralph/prd.json, scripts/ralph/progress.txt.
- Learnings for future iterations:
  - Reusable pattern: Keep CI artifact checks in a standalone script with overridable `--artifact` inputs so both workflows and tests can share the same verification logic.
  - Gotcha: Treat whitespace-only files as empty artifacts; size checks alone are not enough for reliable release evidence.
  - Useful context: Required release-gates evidence currently includes four files under `artifacts/evals/` for jurisdiction evaluation and suite outputs.
---
