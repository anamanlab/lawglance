name: Staging End-to-End Smoke Tests

on:
  pull_request:
  workflow_dispatch:

jobs:
  smoke-e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install uv
        uses: astral-sh/setup-uv@e58605a9b6da7c637471fab8847a5e5a6b8df081 # v5
        with:
          python-version: "3.11"

      - name: Sync dependencies
        run: uv sync --dev

      - name: Run staging smoke tests
        env:
          API_BEARER_TOKEN: smoke-token
          ENVIRONMENT: staging
          ENABLE_SCAFFOLD_PROVIDER: "true"
          ALLOW_SCAFFOLD_SYNTHETIC_CITATIONS: "true"
          STAGING_SMOKE_REPORT_PATH: artifacts/evals/staging-smoke-report.json
        run: bash scripts/run_api_smoke_tests.sh

      - name: Upload staging smoke artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: staging-smoke-artifacts
          path: |
            artifacts/evals/staging-smoke-report.json
            /tmp/immcad_smoke.log
            /tmp/immcad_chat.json
            /tmp/immcad_refusal.json
            /tmp/immcad_cases.json

      - name: Rollback trigger guidance
        if: failure()
        run: |
          echo "Staging smoke checks failed."
          echo "Follow rollback trigger criteria in docs/release/staging-smoke-rollback-criteria.md."
