name: Release Gates

on:
  workflow_dispatch:
    inputs:
      require_legal_checkboxes:
        description: "Require all legal-review checklist items to be checked"
        required: true
        type: boolean
        default: true

jobs:
  release-readiness:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          python-version: "3.11"

      - name: Sync dependencies
        run: uv sync --dev

      - name: Validate legal review checklist (structure)
        run: uv run python scripts/validate_legal_review_checklist.py

      - name: Validate legal review checklist (strict)
        if: ${{ inputs.require_legal_checkboxes == true }}
        run: uv run python scripts/validate_legal_review_checklist.py --require-checked

      - name: Generate jurisdictional readiness report
        env:
          PYTHONPATH: src
        run: uv run python scripts/generate_jurisdiction_eval_report.py

      - name: Run jurisdictional behavior suite
        env:
          PYTHONPATH: src
        run: uv run python scripts/run_jurisdictional_test_suite.py

      - name: Verify release evaluation artifacts
        run: uv run python scripts/verify_release_eval_artifacts.py

      - name: Validate release runtime flags (production-safe)
        env:
          API_BEARER_TOKEN: release-smoke-token
          ENVIRONMENT: ci
          ENABLE_SCAFFOLD_PROVIDER: "true"
          ALLOW_SCAFFOLD_SYNTHETIC_CITATIONS: "false"
        run: uv run python scripts/validate_release_runtime_flags.py

      - name: Run staging API smoke tests
        env:
          API_BEARER_TOKEN: release-smoke-token
          ENVIRONMENT: ci
          ENABLE_SCAFFOLD_PROVIDER: "true"
          ALLOW_SCAFFOLD_SYNTHETIC_CITATIONS: "false"
        run: bash scripts/run_api_smoke_tests.sh

      - name: Repository hygiene checks
        run: bash scripts/check_repository_hygiene.sh

      - name: Upload release evaluation artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-eval-artifacts
          path: |
            artifacts/evals/jurisdiction-eval-report.json
            artifacts/evals/jurisdiction-eval-report.md
            artifacts/evals/jurisdictional-suite-report.json
            artifacts/evals/jurisdictional-suite-report.md
