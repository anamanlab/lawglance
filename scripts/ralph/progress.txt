# Ralph Progress Log
Started: 2026-02-23

## Codebase Patterns
- Run `make quality` before each commit.
- Keep architecture docs in sync when changing API contracts or runtime behavior.
- Canada-only legal scope is mandatory; avoid India-domain terms outside legacy archival files.
- Use small, single-owner stories and validate with targeted tests before moving to the next story.

---
## 2026-02-23 18:05:47 -03 - US-001
- Verified and accepted the pre-existing domain-leak scanner implementation for Canada scope (`scripts/scan_domain_leaks.py`) and its tests, then completed Ralph bookkeeping for the story.
- Files changed
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
- Reusable pattern: Validation scripts are implemented as importable Python modules with a small `main()` entrypoint plus direct unit tests using `importlib`.
- Gotcha: `make` is not installed in this environment, so run the `quality` target commands manually in `Makefile` order and record that equivalence in progress.
- Useful context: `US-001` code already exists on `ralph/canada-hardening-next-loop` (`scripts/scan_domain_leaks.py`, `tests/test_domain_leak_scanner.py`) and passed the full quality gate.
---
## 2026-02-23 18:11:59 -03 - US-002
- Added a release runtime flag validator script (`scripts/validate_release_runtime_flags.py`) with explicit failure output for missing/unsafe prod-like env flags, wired it into `.github/workflows/release-gates.yml` before staging smoke, and added unit tests covering safe and failing configurations.
- Files changed
- `.github/workflows/release-gates.yml`
- `scripts/validate_release_runtime_flags.py`
- `tests/test_validate_release_runtime_flags.py`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
- Reusable pattern: Keep validation scripts importable (`validate_env(...)`) and make `main()` return an exit code so tests can verify both validation logic and CLI failure output.
- Gotcha: `scripts/ralph/prd.json` branch targets can drift across branches; verify the PRD on the branch you will commit to before doing Ralph bookkeeping to avoid cross-branch story mismatch.
- Useful context: `make` is not installed here, but the full `quality` target passed when run manually in `Makefile` order (`ruff`, `pytest`, architecture/source/legal validators, jurisdiction eval/suite, hygiene).
---
## 2026-02-23 18:38:40 -0300 - US-003
- Implemented a normalized retrieved-document model and citation mapping helper so grounded chat/retriever flows can share a consistent document shape and citation conversion.
- Files changed
- `src/immcad_api/retrieval.py`
- `tests/test_retrieval_documents.py`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern: keep retrieval records in a small normalized model and centralize conversion to API citation objects in one helper to avoid duplicate mapper logic.
  - Gotcha: `make` is unavailable in this environment; run the `quality` target command sequence directly from `Makefile` in the same order.
  - Useful context: optional citation metadata (title/url/pin) should degrade to stable defaults so missing retriever fields do not crash chat grounding paths.
---
