# Ralph Progress Log
Started: 2026-02-23

## Codebase Patterns
- Run `make quality` before each commit.
- Keep architecture docs in sync when changing API contracts or runtime behavior.
- Canada-only legal scope is mandatory; avoid India-domain terms outside legacy archival files.

---
## 2026-02-23 18:19:13 -0300 - US-001
- Implemented a reusable domain-leak scanner (`scripts/scan_domain_leaks.py`) that scans source/docs paths for disallowed India-domain legal terms, supports an explicit legacy-file allowlist, and reports file/line context with non-zero exit on violations.
- Files changed
- `scripts/scan_domain_leaks.py`
- `tests/test_domain_leak_scanner.py`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern: Implement validation scripts as importable modules with a small `main()` that returns an exit code so unit tests can cover both library behavior and CLI output.
  - Gotcha: `make` is not installed here, so `make quality` must be executed via the Makefile command sequence manually; full `pytest` currently fails earlier on a pre-existing unrelated `ChatService` constructor mismatch from dirty workspace changes.
  - Useful context: `scripts/scan_domain_leaks.py` defaults to scanning top-level app modules plus `src/immcad_api` and `docs`, with allowlisted legacy files for expected historical references.
---
## 2026-02-23 18:33:41 -0300 - US-002
- Wired the domain-leak scanner into both local and CI quality gates by adding a dedicated Makefile target and making it part of `quality`, plus a new `quality-gates.yml` step that runs the scanner before evaluation artifacts.
- Files changed
- `Makefile`
- `.github/workflows/quality-gates.yml`
- `tests/test_ralph_prd_json.py`
- `src/immcad_api/services/chat_service.py`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern: Add new guardrail scripts as first-class Makefile targets, then compose them into `quality` and mirror the same order in CI workflows.
  - Gotcha: `make` is not installed in this environment, so `make quality` must be executed via the Makefile command sequence manually and in order.
  - Useful context: Updating story `passes` flags requires `tests/test_ralph_prd_json.py` to validate boolean shape instead of enforcing all stories as incomplete.
---
## 2026-02-23 19:17:44 -0300 - US-003
- Implemented structured audit events in the chat flow for `policy_block` and `provider_error`, threading `trace_id` from the API route to `ChatService` and emitting non-PII metadata (`locale`, `mode`, `message_length`, plus provider/error code when applicable).
- Files changed
- `src/immcad_api/api/routes/chat.py`
- `src/immcad_api/services/chat_service.py`
- `tests/test_chat_service.py`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern: Emit audit logs through a dedicated logger (`immcad_api.audit`) with a single structured `audit_event` payload for stable tests and downstream parsing.
  - Gotcha: `scripts/ralph/prd.json` can differ by branch, so pick the story from the active branch-local PRD before coding.
  - Useful context: Pass `trace_id` from route handlers into service methods whenever service-layer audit events are required.
---
## 2026-02-23 19:29:38 -0300 - US-004
- Added a new ingestion checkpoint recovery runbook with explicit checkpoint file location, corruption recovery flow, full/cadence replay commands, and a post-recovery verification checklist.
- Files changed
- `docs/release/ingestion-checkpoint-recovery.md`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern: Keep operational runbooks command-driven with copy/paste-ready shell blocks and checklist verification commands for faster on-call execution.
  - Gotcha: Ralph PRD branch pointers can differ across branches; verify and follow the branch-local story backlog before implementation.
  - Useful context: Ingestion checkpoint state lives at `artifacts/ingestion/checkpoints.json` and can be safely rebuilt by replaying `scripts/run_ingestion_jobs.py` with `--state-path`.
---
## 2026-02-23 19:53:34 -0300 - US-005
- Implemented a release artifact validator (`scripts/validate_release_artifacts.py`) that enforces presence, readability, non-empty content, and JSON validity for required jurisdiction evaluation artifacts, then wired it into `release-gates.yml` before smoke/hygiene/upload steps.
- Files changed: `.github/workflows/release-gates.yml`, `scripts/validate_release_artifacts.py`, `tests/test_validate_release_artifacts.py`, `scripts/ralph/prd.json`, `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern: keep release gate validators importable with a small CLI wrapper so unit tests can directly assert failure categories without shelling out.
  - Gotcha: running `ruff` on YAML paths produces parser noise; lint only Python paths and validate workflows via CI execution.
  - Useful context: release evidence now hard-fails if any of the four eval artifacts are missing, blank, or malformed JSON before upload.
---
## 2026-02-23 20:13:18 -0300 - US-001
- What was implemented
- Added the missing tribunal rules source IDs for ID/IAD/RPD/RAD and compliance source IDs for PIPEDA, CASL, and CanLII Terms to the canonical Canada source registry with valid HTTPS URLs and allowed source metadata fields.
- Files changed
- `data/sources/canada-immigration/registry.json`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern: Keep the legal source registry grouped by legal domain (statutes/regulations/policy/case-law) so future source additions remain reviewable and diff-friendly.
  - Gotcha: `make` is unavailable in this environment, so `make quality` must be executed via the exact Makefile command sequence.
  - Useful context: `source_type` is constrained to `statute|regulation|policy|case_law` and `update_cadence` to `daily|weekly|scheduled_incremental`; invalid values fail registry load/quality checks.
---
## 2026-02-23 20:17:46 -0300 - US-002
- What was implemented
- Enforced strict source-registry validation by introducing a canonical required production source ID set (including tribunal and compliance IDs), wiring it into the source-registry validator and jurisdiction readiness checks, and adding tests that assert explicit missing-ID failure output.
- Files changed
- `src/immcad_api/sources/required_sources.py`
- `src/immcad_api/sources/__init__.py`
- `scripts/validate_source_registry.py`
- `src/immcad_api/evaluation/jurisdiction.py`
- `tests/test_canada_registry.py`
- `tests/test_validate_source_registry.py`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern
  - Centralize compliance-critical ID allowlists in one importable module so validators, runtime checks, and tests cannot drift.
  - Gotcha
  - `make` is not installed in this environment; run the exact `quality` Makefile command chain manually and in order.
  - Useful context
  - `scripts/validate_source_registry.py` now returns non-zero with `[ERROR] Missing required source IDs: ...` and is executed in both local quality and CI quality gates.
---
## 2026-02-23 20:21:16 -0300 - US-003
- What was implemented
- Disabled synthetic CanLII scaffold case output for `production`/`prod`/`ci` by wiring environment-aware fallback policy into `CanLIIClient`; unavailable CanLII now raises a safe provider error instead of returning synthetic cases.
- Added coverage for strict CanLII behavior (no API key / HTTP failure with scaffold fallback disabled) and an API contract test asserting `/api/search/cases` returns a structured `PROVIDER_ERROR` envelope with matching `trace_id` in production mode.
- Documented case-law fallback behavior to clarify non-prod scaffold behavior vs production-safe error behavior.
- Files changed
- `src/immcad_api/sources/canlii_client.py`
- `src/immcad_api/main.py`
- `tests/test_canlii_client.py`
- `tests/test_api_scaffold.py`
- `src/immcad_api/README.md`
- `docs/architecture/api-contracts.md`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern
  - Gate scaffold/dev-only fallbacks at composition boundaries (`create_app`) and pass explicit behavior flags into adapters so production constraints stay centralized and testable.
  - Gotcha
  - `make` is unavailable in this environment; run the exact `quality` target command chain manually in Makefile order to preserve gate parity.
  - Useful context
  - Provider error envelopes already include `error.trace_id` and `x-trace-id` through shared exception handlers, so source/client failures can be surfaced safely without route-specific envelope code.
---
## 2026-02-23 20:24:57 -0300 - US-004
- What was implemented
- Expanded policy refusal matching to cover additional representation, on-behalf filing, personalized strategy, and broader guarantee-request phrases while preserving informational query access.
- Added blocked+allowed policy prompt tests and strengthened refusal contract assertions so policy-block responses stay low-confidence with the standard disclaimer.
- Files changed
- `src/immcad_api/policy/compliance.py`
- `src/immcad_api/evaluation/jurisdiction.py`
- `tests/test_policy_compliance.py`
- `tests/test_chat_service.py`
- `tests/test_api_scaffold.py`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern
  - Pair expanded refusal matchers with both blocked and neutral allow-list tests to reduce false positives while widening safety coverage.
  - Gotcha
  - Regexes with optional word windows (`(?: [a-z]+){0,n}`) still need explicit spaces before trailing anchors to match zero-word variants.
  - Useful context
  - Policy refusal contract is enforced via `POLICY_REFUSAL_TEXT`, `confidence="low"`, and `DISCLAIMER_TEXT`; asserting these in both service and API tests catches regressions early.
---
## 2026-02-23 20:29:02 -0300 - US-005
- What was implemented
- Wired `ALLOW_SCAFFOLD_SYNTHETIC_CITATIONS` into runtime settings and `ChatService`, enforced production fail-fast when synthetic citations are enabled, and added an API test for safe constrained responses when grounded citations are unavailable.
- Files changed
- `.env.example`
- `docs/architecture/api-contracts.md`
- `src/immcad_api/README.md`
- `src/immcad_api/main.py`
- `src/immcad_api/settings.py`
- `tests/test_api_scaffold.py`
- `tests/test_settings.py`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern
  - Enforce production-only safety invariants in `load_settings()` and pass explicit flags into services from `create_app()` so behavior is deterministic across environments.
  - Gotcha
  - Existing production-mode tests must set all required hardening env vars (now including `ALLOW_SCAFFOLD_SYNTHETIC_CITATIONS=false`) or app creation fails by design.
- Useful context
- With synthetic citations disabled, chat responses use the existing citation-enforcement safe fallback text and return `confidence="low"` with empty citations instead of fabricating references.
---
## 2026-02-23 20:32:28 -0300 - US-006
- What was implemented
- Locked provider routing contract by requiring the router's declared primary provider to be the first provider in ordered routing.
- Added API coverage for a transient OpenAI timeout that falls back to Gemini and asserts stable `fallback_used.reason = "timeout"` propagation in the chat response, plus recovery on the next request back to primary.
- Added router unit coverage to fail fast when provider order violates the primary-first routing invariant.
- Files changed
- `src/immcad_api/providers/router.py`
- `tests/test_api_scaffold.py`
- `tests/test_provider_router_circuit_breaker.py`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern
  - Enforce critical routing invariants in constructor validation and back them with integration tests that assert response-envelope fields, not only internal router state.
  - Gotcha
  - `make` is unavailable in this environment; run the exact `quality` Makefile command chain manually and in order to preserve gate equivalence.
  - Useful context
- `fallback_used.reason` in API responses comes from router `last_error.code`; transient primary failures should be validated at API level to prevent contract regressions.
---
## 2026-02-23 20:35:54 -0300 - US-007
- What was implemented
- Strengthened API security coverage by adding tests that enforce bearer-token auth behavior across `production`/`prod`/`ci` modes and verify unauthorized responses return structured envelopes with trace correlation headers.
- Added regression coverage for rate-limiter client ID resolution failures to ensure `/api/*` requests return structured `400 VALIDATION_ERROR` envelopes with `trace_id` and matching `x-trace-id`.
- Expanded rate-limit/auth envelope assertions to validate trace header-to-body consistency on `401` and `429` responses.
- Files changed
- `tests/test_api_scaffold.py`
- `tests/test_settings.py`
- `scripts/ralph/prd.json`
- `scripts/ralph/progress.txt`
- Learnings for future iterations:
  - Reusable pattern
  - For middleware-level guards, assert both HTTP status and trace correlation (`error.trace_id` == `x-trace-id`) so observability contracts stay intact.
  - Gotcha
  - Production-mode tests require `ALLOW_SCAFFOLD_SYNTHETIC_CITATIONS=false`; otherwise app boot fails before auth/rate-limit checks execute.
  - Useful context
  - Simulating rate-limit client identity failures is easiest by monkeypatching `_resolve_rate_limit_client_id` to return `None`, which exercises the exact 400 envelope branch.
---
