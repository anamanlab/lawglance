name: Cloudflare Backend Native Deploy

on:
  push:
    branches:
      - main
    paths:
      - "src/immcad_api/**"
      - "backend-cloudflare/**"
      - "config/source_policy.yaml"
      - "data/policy/document_compilation_rules.ca.json"
      - "data/sources/canada-immigration/registry.json"
      - "scripts/sync_backend_cloudflare_native_source.sh"
      - "scripts/sync_cloudflare_backend_native_secrets.sh"
      - ".github/workflows/cloudflare-backend-native-deploy.yml"
  workflow_dispatch:

concurrency:
  group: cloudflare-backend-native-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-backend-native:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"

      - name: Validate Cloudflare credentials are configured
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          IMMCAD_API_BEARER_TOKEN: ${{ secrets.IMMCAD_API_BEARER_TOKEN }}
          API_BEARER_TOKEN: ${{ secrets.API_BEARER_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          required_vars=(
            CLOUDFLARE_API_TOKEN
            CLOUDFLARE_ACCOUNT_ID
            GEMINI_API_KEY
          )
          for required_var in "${required_vars[@]}"; do
            if [ -z "${!required_var}" ]; then
              echo "${required_var} secret is required."
              exit 1
            fi
          done
          if [ -z "${IMMCAD_API_BEARER_TOKEN}" ] && [ -z "${API_BEARER_TOKEN}" ]; then
            echo "Either IMMCAD_API_BEARER_TOKEN or API_BEARER_TOKEN secret is required."
            exit 1
          fi
          if [ -n "${IMMCAD_API_BEARER_TOKEN}" ] && [ -n "${API_BEARER_TOKEN}" ] && [ "${IMMCAD_API_BEARER_TOKEN}" != "${API_BEARER_TOKEN}" ]; then
            echo "IMMCAD_API_BEARER_TOKEN and API_BEARER_TOKEN must match when both are set."
            exit 1
          fi

      - name: Sync backend runtime source for native worker
        run: bash scripts/sync_backend_cloudflare_native_source.sh

      - name: Setup Python worker toolchain
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install uv
          cd backend-cloudflare
          uv sync --dev

      - name: Sync backend native worker secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          IMMCAD_API_BEARER_TOKEN: ${{ secrets.IMMCAD_API_BEARER_TOKEN }}
          API_BEARER_TOKEN: ${{ secrets.API_BEARER_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CANLII_API_KEY: ${{ secrets.CANLII_API_KEY }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
        run: |
          resolved_bearer_token="${IMMCAD_API_BEARER_TOKEN:-${API_BEARER_TOKEN:-}}"
          if [ -z "${resolved_bearer_token}" ]; then
            echo "Either IMMCAD_API_BEARER_TOKEN or API_BEARER_TOKEN secret is required."
            exit 1
          fi
          export IMMCAD_API_BEARER_TOKEN="${resolved_bearer_token}"
          export API_BEARER_TOKEN="${resolved_bearer_token}"
          bash scripts/sync_cloudflare_backend_native_secrets.sh \
            IMMCAD_API_BEARER_TOKEN \
            API_BEARER_TOKEN \
            GEMINI_API_KEY \
            CANLII_API_KEY \
            REDIS_URL

      - name: Deploy backend native Python worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd backend-cloudflare
          uv run pywrangler deploy
