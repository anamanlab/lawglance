name: Cloudflare Backend Proxy Deploy

on:
  push:
    branches:
      - main
    paths:
      - "backend-cloudflare/**"
      - ".github/workflows/cloudflare-backend-proxy-deploy.yml"
  workflow_dispatch:

concurrency:
  group: cloudflare-backend-proxy-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-backend-proxy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"

      - name: Validate Cloudflare free-plan proxy readiness
        env:
          CLOUDFLARE_BACKEND_MODE: proxy
        run: bash scripts/check_cloudflare_free_plan_readiness.sh

      - name: Validate Cloudflare edge-proxy contract
        run: bash scripts/check_cloudflare_edge_proxy_contract.sh

      - name: Validate Cloudflare credentials are configured
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          IMMCAD_BACKEND_ORIGIN: ${{ secrets.IMMCAD_BACKEND_ORIGIN }}
        run: |
          if [ -z "${CLOUDFLARE_API_TOKEN}" ]; then
            echo "CLOUDFLARE_API_TOKEN secret is required."
            exit 1
          fi
          if [ -z "${CLOUDFLARE_ACCOUNT_ID}" ]; then
            echo "CLOUDFLARE_ACCOUNT_ID secret is required."
            exit 1
          fi
          if [ -z "${IMMCAD_BACKEND_ORIGIN}" ]; then
            echo "IMMCAD_BACKEND_ORIGIN secret is required."
            exit 1
          fi

      - name: Inject backend origin
        env:
          IMMCAD_BACKEND_ORIGIN: ${{ secrets.IMMCAD_BACKEND_ORIGIN }}
        run: |
          sed -i "s#https://backend-origin.example#${IMMCAD_BACKEND_ORIGIN}#g" backend-cloudflare/wrangler.backend-proxy.jsonc

      - name: Deploy backend proxy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx --yes wrangler@4.68.1 deploy --config backend-cloudflare/wrangler.backend-proxy.jsonc
